# GEE Thermal ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#3-æ ¸å¿ƒè®¾è®¡åŸåˆ™)
4. [æ¨¡å—è¯¦è§£](#4-æ¨¡å—è¯¦è§£)
5. [å·¥ä½œæµç¨‹](#5-å·¥ä½œæµç¨‹)
6. [å…³é”®æŠ€æœ¯å®ç°](#6-å…³é”®æŠ€æœ¯å®ç°)
7. [æ‰©å±•æŒ‡å—](#7-æ‰©å±•æŒ‡å—)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

æœ¬é¡¹ç›®æ—¨åœ¨è§£å†³å¤§è§„æ¨¡é¥æ„Ÿæ•°æ®æ‰¹é‡å¤„ç†å’Œä¸‹è½½çš„å·¥ç¨‹é—®é¢˜ã€‚åœ¨åŸå¸‚çƒ­å²›æ•ˆåº”ç ”ç©¶ä¸­ï¼Œéœ€è¦è·å–é•¿æ—¶é—´åºåˆ—çš„åœ°è¡¨æ¸©åº¦ï¼ˆLSTï¼‰æ•°æ®ï¼Œæ¶‰åŠæ•°ç™¾ç”šè‡³æ•°åƒå¼ å½±åƒçš„å¤„ç†ã€‚ä¼ ç»Ÿçš„æ‰‹åŠ¨å¤„ç†æ–¹å¼æ•ˆç‡ä½ä¸‹ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| **è‡ªåŠ¨åŒ–** | è‡ªåŠ¨å®Œæˆä»æ•°æ®ç­›é€‰ã€å¤„ç†ã€å¯¼å‡ºåˆ°ä¸‹è½½çš„å…¨æµç¨‹ |
| **å¯é æ€§** | æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œä»»åŠ¡å¤±è´¥è‡ªåŠ¨é‡è¯• |
| **å¯æ‰©å±•** | æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°çš„æ•°æ®æºå’Œç®—æ³• |
| **å¯è¿½æº¯** | å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œè´¨é‡è¿½è¸ª |

### 1.3 æ ¸å¿ƒåŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GEE Thermal ç³»ç»ŸåŠŸèƒ½                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¡ æ•°æ®è·å–        â”‚  è®¡ç®—å¤„ç†        â”‚  ä»»åŠ¡ç®¡ç†            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  â€¢ Landsat ç³»åˆ—    â”‚  â€¢ LST åæ¼”      â”‚  â€¢ å¹¶è¡Œä»»åŠ¡æ§åˆ¶       â”‚
â”‚  â€¢ MODIS äº§å“      â”‚  â€¢ äº‘æ©è†œå¤„ç†    â”‚  â€¢ çŠ¶æ€æŒä¹…åŒ–         â”‚
â”‚  â€¢ ERA5 æ°”è±¡æ•°æ®   â”‚  â€¢ è´¨é‡è¯„ä¼°      â”‚  â€¢ è‡ªåŠ¨é‡è¯•æœºåˆ¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·å…¥å£å±‚                                 â”‚
â”‚                        __main__.py                                  â”‚
â”‚              (å‘½ä»¤è¡Œå‚æ•°è§£æ â†’ lst / era5 / thermal)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸šåŠ¡æµç¨‹å±‚                                 â”‚
â”‚                         processes.py                                â”‚
â”‚         (process_lst / process_era5 / process_thermal)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Controller å±‚       â”‚ â”‚ Calculator  â”‚ â”‚     Communicator å±‚     â”‚
â”‚    (æµç¨‹æ§åˆ¶ä¸è°ƒåº¦)       â”‚ â”‚   å±‚        â”‚ â”‚    (å¤–éƒ¨æœåŠ¡é€šä¿¡)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  (æ•°æ®è®¡ç®—)  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ LstController         â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â€¢ ProjectManager        â”‚
â”‚ â€¢ Era5Controller        â”‚ â”‚LstCalculatorâ”‚ â”‚ â€¢ EEManager (GEE)       â”‚
â”‚ â€¢ ModisController       â”‚ â”‚Era5Calcul...â”‚ â”‚ â€¢ DriveManager (Drive)  â”‚
â”‚ â€¢ Image (å¯¼å‡ºå°è£…)       â”‚ â”‚MoodisCalc...â”‚ â”‚ â€¢ CityAsset (èµ„äº§å°è£…)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚
                    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Monitor å±‚         â”‚ â”‚              Algorithm å±‚               â”‚
â”‚     (ä»»åŠ¡ç›‘æ§ä¸è¿½è¸ª)      â”‚ â”‚            (æ ¸å¿ƒç®—æ³•å®ç°)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Monitor (ä¸»æ§åˆ¶å™¨)     â”‚ â”‚ lst_algorithm/                         â”‚
â”‚ â€¢ TaskTracker (ä»»åŠ¡è¿½è¸ª) â”‚ â”‚   â”œâ”€â”€ landsat_lst.py (LSTä¸»ç®—æ³•)        â”‚
â”‚ â€¢ Counter (å¹¶è¡Œè®¡æ•°)     â”‚ â”‚   â”œâ”€â”€ smw_algorithm.py (SMWç®—æ³•)       â”‚
â”‚ â€¢ TaskState (çŠ¶æ€æœº)     â”‚ â”‚   â”œâ”€â”€ cloudmask.py (äº‘æ©è†œ)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”œâ”€â”€ compute_*.py (å„æŒ‡æ•°è®¡ç®—)         â”‚
                            â”‚ era_algorithm/                          â”‚
                            â”‚   â””â”€â”€ era5_wind.py (ERA5æ•°æ®è·å–)        â”‚
                            â”‚ modis_algorithm/                        â”‚
                            â”‚   â””â”€â”€ modis_lst.py (MODIS LST)          â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æµå‘å›¾                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    GEE API     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  GEE æ•°æ®é›†  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  å½±åƒè®¡ç®—    â”‚
  â”‚  (äº‘ç«¯)      â”‚               â”‚  (GEEæœåŠ¡ç«¯) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼ Export.toDrive()
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ Google Drive  â”‚
                               â”‚  (äº‘ç«¯æš‚å­˜)    â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼ PyDrive ä¸‹è½½
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚   æœ¬åœ°å­˜å‚¨     â”‚
                               â”‚  (GeoTIFF)    â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 3.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)

æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½ï¼š

| æ¨¡å— | èŒè´£ |
|------|------|
| `Calculator` | ä»…è´Ÿè´£æ•°æ®è®¡ç®—ï¼Œä¸æ¶‰åŠå¯¼å‡ºé€»è¾‘ |
| `Controller` | ä»…è´Ÿè´£æµç¨‹æ§åˆ¶ï¼Œä¸æ¶‰åŠå…·ä½“ç®—æ³• |
| `Monitor` | ä»…è´Ÿè´£ä»»åŠ¡ç›‘æ§ï¼Œä¸æ¶‰åŠæ•°æ®å¤„ç† |
| `Tracker` | ä»…è´Ÿè´£å•ä¸ªä»»åŠ¡çš„çŠ¶æ€è¿½è¸ª |

### 3.2 å¼€é—­åŸåˆ™ (OCP)

é€šè¿‡æŠ½è±¡ç±»å’Œå·¥å‚æ¨¡å¼ï¼Œç³»ç»Ÿå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ï¼š

```python
# æŠ½è±¡åŸºç±»å®šä¹‰æ¥å£
class Calculator(ABC):
    @abstractmethod
    def calculate(self, year: int, month: int) -> ee.Image:
        pass

# æ–°å¢æ•°æ®æºåªéœ€ç»§æ‰¿å®ç°
class NewDataCalculator(Calculator):
    def calculate(self, year: int, month: int) -> ee.Image:
        # å®ç°å…·ä½“é€»è¾‘
        pass
```

### 3.3 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—çš„å…·ä½“å®ç°ï¼š

```python
# Controller ä¾èµ–æŠ½è±¡çš„ Calculator æ¥å£
def create_image_series(self, calculator: Calculator):
    # ä¸å…³å¿ƒæ˜¯ LstCalculator è¿˜æ˜¯ Era5Calculator
    bands = calculator.calculate(year, month)
```

### 3.4 çŠ¶æ€æœºæ¨¡å¼

ä»»åŠ¡è¿½è¸ªé‡‡ç”¨çŠ¶æ€æœºè®¾è®¡ï¼Œç¡®ä¿çŠ¶æ€è½¬æ¢çš„å¯æ§æ€§ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HoldStateâ”‚ â”€â”€â”€â†’ â”‚ExportStateâ”‚ â”€â”€â”€â†’ â”‚DownloadStateâ”‚ â”€â”€â”€â†’ â”‚Completed â”‚
â”‚ (ç­‰å¾…)    â”‚      â”‚ (å¯¼å‡ºä¸­)  â”‚      â”‚ (ä¸‹è½½ä¸­)  â”‚      â”‚ (å®Œæˆ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                  â”‚
     â”‚                 â”‚                  â”‚
     â–¼                 â–¼                  â–¼
  [ç­‰å¾…å¹¶è¡Œæ§½ä½]    [ç›‘æ§GEEä»»åŠ¡]      [ä»Driveä¸‹è½½]
```

### 3.5 å•ä¾‹æ¨¡å¼

`Counter` ç±»ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªä»»åŠ¡è®¡æ•°å™¨ï¼š

```python
@singleton
class Counter:
    def __init__(self):
        self.count = 0
```

---

## 4. æ¨¡å—è¯¦è§£

### 4.1 Communicator æ¨¡å—

#### ProjectManager

é¡¹ç›®ç®¡ç†å™¨ï¼Œè´Ÿè´£åˆå§‹åŒ–å’Œåè°ƒå„ä¸ªç®¡ç†å™¨ï¼š

```python
class ProjectManager:
    def initialize(self) -> bool:
        self._init_cloud()   # åˆå§‹åŒ– GEE å’Œ Drive
        self._init_local()   # åˆå§‹åŒ–æœ¬åœ°ç›®å½•å’Œæ–‡ä»¶
```

#### EEManager

å°è£… Google Earth Engine æ“ä½œï¼š

- GEE é¡¹ç›®åˆå§‹åŒ–
- åŸå¸‚è¾¹ç•Œèµ„äº§è·å–
- åŸå¸‚å‡ ä½•èŒƒå›´ç®¡ç†

#### DriveManager

å°è£… Google Drive æ“ä½œï¼š

- OAuth 2.0 è®¤è¯ç®¡ç†
- æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢
- Token è‡ªåŠ¨åˆ·æ–°

#### CityAsset

åŸå¸‚èµ„äº§æ•°æ®ç±»ï¼Œå°è£…åŸå¸‚ç›¸å…³çš„åœ°ç†ä¿¡æ¯ï¼š

- è¡Œæ”¿è¾¹ç•Œï¼ˆcity_geometryï¼‰
- åŸå¸‚å»ºæˆåŒºè¾¹ç•Œï¼ˆurban_geometryï¼‰
- ä¸­å¿ƒçº¬åº¦ï¼ˆç”¨äº LST æ ¡æ­£ï¼‰

### 4.2 Controller æ¨¡å—

#### Controller åŸºç±»

å®šä¹‰æ§åˆ¶å™¨çš„é€šç”¨è¡Œä¸ºï¼š

```python
class Controller(ABC):
    def __init__(self, project_manager):
        self.monitor = Monitor(...)      # åˆ›å»ºç›‘æ§å™¨
        self.exclude_list = self._create_exclude_list()  # å·²å¤„ç†åˆ—è¡¨
    
    @abstractmethod
    def create_image_series(self, calculator):
        pass
```

#### LstController

Landsat LST å¤„ç†æ§åˆ¶å™¨ï¼š

- æ”¯æŒå¹´ä»½èŒƒå›´æˆ–æŒ‡å®šæ—¥æœŸå¤„ç†
- è°ƒç”¨ `LstParser` è¿›è¡Œåå¤„ç†

#### Era5Controller / ModisController

æ°”è±¡å’Œ MODIS æ•°æ®æ§åˆ¶å™¨ï¼Œéœ€è¦æŒ‡å®šæ—¥æœŸæ–‡ä»¶ã€‚

### 4.3 Calculator æ¨¡å—

#### Calculator åŸºç±»

```python
class Calculator(ABC):
    def __init__(self, city_asset, quality_file_path, 
                 missing_file_path, pixel_resolution):
        self.pixel_resolution = pixel_resolution  # è¾“å‡ºåˆ†è¾¨ç‡
        self.map_days = self._create_map_days()   # æ—¥æœŸæ˜ å°„
    
    @abstractmethod
    def calculate(self, year: int, month: int) -> ee.Image:
        pass
```

#### LstCalculator

LST è®¡ç®—å™¨æ ¸å¿ƒé€»è¾‘ï¼š

1. æŒ‰é¡ºåºå°è¯• L8 â†’ L5 â†’ L7 â†’ L4
2. ç­›é€‰äº‘é‡æœ€ä½çš„å½±åƒ
3. è®¡ç®—å¤šç§åœ°è¡¨æŒ‡æ•°
4. åº”ç”¨ SMW ç®—æ³•åæ¼” LST

### 4.4 Monitor æ¨¡å—

#### Monitor

ä¸»ç›‘æ§å™¨ï¼Œç®¡ç†å¤šä¸ªä»»åŠ¡è¿½è¸ªå™¨ï¼š

```python
class Monitor:
    def start(self):
        self._load_trackers()        # åŠ è½½æŒä¹…åŒ–çš„è¿½è¸ªå™¨
        self._check_trackers()       # å®šæ—¶æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        self._check_and_refresh_token()  # å®šæ—¶åˆ·æ–°Token
```

#### TaskTracker

å•ä»»åŠ¡è¿½è¸ªå™¨ï¼Œå®ç°çŠ¶æ€æœºï¼š

```python
class TaskTracker:
    def start(self):
        self.state = HoldState()     # åˆå§‹çŠ¶æ€
        self.state = self.state.handle(self)  # çŠ¶æ€è½¬æ¢
    
    def dump(self):
        pickle.dump(tracker_data, f)  # æŒä¹…åŒ–åˆ°æ–‡ä»¶
```

#### çŠ¶æ€ç±»

| çŠ¶æ€ | è¡Œä¸º |
|------|------|
| `HoldState` | æ£€æŸ¥å¹¶è¡Œæ§½ä½ï¼Œæ»¡è¶³æ¡ä»¶ååˆ›å»ºå¯¼å‡ºä»»åŠ¡ |
| `ExportState` | è½®è¯¢ GEE ä»»åŠ¡çŠ¶æ€ï¼Œå®Œæˆåè¿›å…¥ä¸‹è½½ |
| `DownloadState` | ä» Drive ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ° |
| `CompletedState` | åˆ é™¤äº‘ç«¯æ–‡ä»¶ï¼Œé‡Šæ”¾å¹¶è¡Œæ§½ä½ |

### 4.5 Algorithm æ¨¡å—

#### LST ç®—æ³•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LST åæ¼”ç®—æ³•æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Landsat TOA + SR å½±åƒ
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€å°äº‘é‡ç­›é€‰     â”‚  â†’ é€‰æ‹©åŸå¸‚å»ºæˆåŒºäº‘é‡æœ€ä½çš„å½±åƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº‘æ©è†œå¤„ç†       â”‚  â†’ åŸºäº QA æ³¢æ®µå‰”é™¤äº‘åƒç´ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒ‡æ•°è®¡ç®—         â”‚ â”€â”€â†’ â”‚ NDVI, FVC, NDBI, EVI, Green       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘å°„ç‡ä¼°ç®—       â”‚  â†’ åŸºäº FVC å’Œ NDVI è®¡ç®—åœ°è¡¨å‘å°„ç‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤§æ°”æ°´æ±½è·å–     â”‚  â†’ ä» NCEP æ•°æ®è·å– TPW
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SMW ç®—æ³•         â”‚  â†’ ç»Ÿè®¡å•çª—ç®—æ³•åæ¼” LST
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ°”æ¸©ä¼°ç®—         â”‚  â†’ SCEN ç®—æ³•ä¼°ç®—æ°”æ¸©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  è¾“å‡ºå¤šæ³¢æ®µ GeoTIFF
```

#### SMW (Statistical Mono-Window) ç®—æ³•

```python
# æ ¸å¿ƒå…¬å¼
LST = A * Tb / Îµ + B / Îµ + C

# å‚æ•°è¯´æ˜ï¼š
# Tb: çƒ­çº¢å¤–æ³¢æ®µäº®æ¸©
# Îµ: åœ°è¡¨å‘å°„ç‡
# A, B, C: åŸºäºå¤§æ°”æ°´æ±½å«é‡çš„æŸ¥æ‰¾è¡¨ç³»æ•°
```

---

## 5. å·¥ä½œæµç¨‹

### 5.1 å®Œæ•´å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®Œæ•´å¤„ç†æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ‰§è¡Œ: python -m src lst 2020 2023
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  å‚æ•°è§£æ      â”‚
            â”‚  ç¯å¢ƒå˜é‡åŠ è½½   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ProjectManagerâ”‚
            â”‚   åˆå§‹åŒ–       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EEManager    â”‚       â”‚ DriveManager  â”‚
â”‚  GEE è®¤è¯     â”‚       â”‚ Drive è®¤è¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LstController â”‚
            â”‚ åˆ›å»ºå½±åƒåºåˆ—   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monitor.start â”‚       â”‚ éå†å¹´-æœˆ    â”‚
â”‚ åŠ è½½å†å²è¿½è¸ªå™¨ â”‚       â”‚ åˆ›å»ºæ–°ä»»åŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                       â”‚
                    â–¼                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Calculator    â”‚       â”‚   è·³è¿‡å·²å®Œæˆ   â”‚
            â”‚ è®¡ç®— LST      â”‚       â”‚   æˆ–è¿›è¡Œä¸­çš„   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Image.export  â”‚
            â”‚ æäº¤åˆ° GEE    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ TaskTracker   â”‚
            â”‚ çŠ¶æ€æœºç›‘æ§     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GEEå¯¼å‡º  â”‚â†’â”‚ Driveä¸‹è½½ â”‚â†’â”‚ æ¸…ç†äº‘ç«¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æœ¬åœ° GeoTIFF â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¹¶è¡Œæ§åˆ¶ç­–ç•¥

```python
# æœ€å¤§å¹¶è¡Œä»»åŠ¡æ•°
HoldState.max_task_num = 5

# å¹¶è¡Œæ§½ä½ç®¡ç†
class HoldState:
    def handle(self, tracker):
        if Counter().get_count() >= self.max_task_num:
            return HoldState()  # ç»§ç»­ç­‰å¾…
        # åˆ›å»ºä»»åŠ¡å¹¶å ç”¨æ§½ä½
        Counter().increment()
        return ExportState()

class CompletedState:
    def handle(self, tracker):
        Counter().decrement()  # é‡Šæ”¾æ§½ä½
        return None
```

### 5.3 æ–­ç‚¹ç»­ä¼ æœºåˆ¶

```
ç¨‹åºå¯åŠ¨
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰«æ tracker_folder   â”‚
â”‚ æŸ¥æ‰¾ .pkl æ–‡ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚
    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ‰è¿½è¸ªå™¨ â”‚   â”‚ æ— è¿½è¸ªå™¨    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¢å¤ä»»åŠ¡çŠ¶æ€    â”‚ â”‚ åˆ›å»ºæ–°ä»»åŠ¡   â”‚
â”‚ ç»§ç»­ç›‘æ§       â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å…³é”®æŠ€æœ¯å®ç°

### 6.1 æœ€å°äº‘é‡å½±åƒç­›é€‰

```python
def minimum_cloud_cover(image_collection, geometry, cloud_cover_geometry, mask_method, date_start):
    """
    æ ¸å¿ƒæ€è·¯ï¼š
    1. æŒ‰é‡‡é›†æ—¥æœŸå¯¹å½±åƒåˆ†ç»„
    2. æ£€æŸ¥æ¯ç»„å½±åƒçš„ç©ºé—´è¦†ç›–ç‡ (>80%)
    3. è®¡ç®—åŸå¸‚å»ºæˆåŒºçš„äº‘è¦†ç›–ç‡
    4. é€‰æ‹©äº‘è¦†ç›–ç‡æœ€ä½çš„å½±åƒ
    """
    best_image = None
    best_cloud_cover = 100
    
    for index in index_list:
        # åˆå¹¶åŒæ—¥æœŸå½±åƒ
        mosaiced_image = image_condidate_list.mosaic().clip(geometry)
        # è®¡ç®—äº‘è¦†ç›–
        cloud_cover = calc_cloud_cover(mosaiced_image, cloud_cover_geometry, mask_method)
        if cloud_cover < best_cloud_cover:
            best_cloud_cover = cloud_cover
            best_image = mosaiced_image
    
    return best_image
```

### 6.2 Token è‡ªåŠ¨åˆ·æ–°

```python
def _check_and_refresh_token(self):
    """
    ç‰¹ç‚¹ï¼š
    1. æŒ‡æ•°é€€é¿é‡è¯•
    2. å®šæ—¶åˆ·æ–°ï¼ˆæ¯75ç§’ï¼‰
    3. æŒä¹…åŒ–ä¿å­˜å‡­è¯
    """
    for attempt in range(max_retries):
        try:
            self.drive_manager.gauth.Refresh()
            self.drive_manager.gauth.SaveCredentialsFile(...)
            break
        except (BrokenPipeError, ConnectionError) as e:
            time.sleep(3 ** attempt)  # 3, 9, 27 ç§’
```

### 6.3 çŠ¶æ€æŒä¹…åŒ–

```python
def dump(self):
    """ä½¿ç”¨ pickle åºåˆ—åŒ–ä»»åŠ¡çŠ¶æ€"""
    tracker_data = {
        'image': self.image,
        'task': self.task,      # GEE Task å¯¹è±¡
        'state': self.state,    # å½“å‰çŠ¶æ€
    }
    with open(self.tracker_file_path, 'wb') as f:
        pickle.dump(tracker_data, f)
```

---

## 7. æ‰©å±•æŒ‡å—

### 7.1 æ·»åŠ æ–°çš„æ•°æ®æº

1. **åˆ›å»º Calculator**

```python
# src/calculator/new_calculator.py
class NewDataCalculator(Calculator):
    def __init__(self, city_asset, ...):
        super().__init__(
            city_asset=city_asset,
            pixel_resolution=100,  # è®¾ç½®è¾“å‡ºåˆ†è¾¨ç‡
            ...
        )
    
    def calculate(self, year: int, month: int) -> ee.Image:
        # å®ç°æ•°æ®è·å–å’Œå¤„ç†é€»è¾‘
        return processed_image
```

2. **åˆ›å»º Controllerï¼ˆå¯é€‰ï¼‰**

å¦‚æœéœ€è¦ç‰¹æ®Šçš„æµç¨‹æ§åˆ¶ï¼Œç»§æ‰¿ `Controller` åŸºç±»ã€‚

3. **æ³¨å†Œåˆ°å…¥å£**

```python
# src/processes.py
def process_new_data(project_manager, city_asset, ...):
    controller = NewDataController(...)
    calculator = NewDataCalculator(...)
    controller.create_image_series(calculator)
```

### 7.2 æ·»åŠ æ–°çš„å¤„ç†ç®—æ³•

1. åœ¨ `lst_algorithm/` æˆ–æ–°å»ºç®—æ³•ç›®å½•ä¸­åˆ›å»ºæ¨¡å—
2. åœ¨ `__init__.py` ä¸­å¯¼å‡º
3. åœ¨ Calculator ä¸­è°ƒç”¨

### 7.3 è‡ªå®šä¹‰åŸå¸‚åŒºåŸŸ

ä¿®æ”¹ `EEManager.get_city_asset()` æˆ–ç›´æ¥ä¼ å…¥è‡ªå®šä¹‰çš„ `ee.Geometry`ã€‚

---

## é™„å½•ï¼šæŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| Google Earth Engine (Python API) | é¥æ„Ÿæ•°æ®å¤„ç† |
| PyDrive | Google Drive æ“ä½œ |
| python-dotenv | ç¯å¢ƒå˜é‡ç®¡ç† |
| pypinyin | ä¸­æ–‡è½¬æ‹¼éŸ³ï¼ˆæ–‡ä»¶å‘½åï¼‰ |
| pickle | å¯¹è±¡åºåˆ—åŒ– |
| threading.Timer | å®šæ—¶ä»»åŠ¡ |

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2024*

